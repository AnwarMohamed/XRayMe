#include "..\XRayMe\XRayMe.h"
#include <iostream>

using namespace std;

UINT VirutSignSize = 137;

static UCHAR VirutSign[137] = {
	0x90, 0xE8, 0x00, 0x00, 0x00, 0x00, 0x8B, 0x04,
	0x24, 0xF7, 0x80, 0x2B, 0x24, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x80, 0x89, 0x98, 0xAC, 0x29, 0x00,
	0x00, 0x8B, 0x5C, 0x24, 0x04, 0x74, 0x2D, 0xFC,
	0x59, 0x89, 0xB0, 0xB0, 0x29, 0x00, 0x00, 0x89,
	0xB8, 0xB4, 0x29, 0x00, 0x00, 0x80, 0xB8, 0x2F,
	0x24, 0x00, 0x00, 0xE8, 0x75, 0x0D, 0x03, 0x98,
	0x30, 0x24, 0x00, 0x00, 0x8B, 0x5B, 0x02, 0xFF,
	0x33, 0xEB, 0x08, 0x8B, 0x98, 0x31, 0x24, 0x00,
	0x00, 0xFF, 0x33, 0x5B, 0x55, 0x95, 0x81, 0x6C,
	0x24, 0x04, 0xB0/* ?? */, 0xB9/* ?? */, 0x05/* ?? */, 0x00/* ?? */, 0x81, 0xE3,
	0x00, 0xF0, 0xFF, 0xFF, 0x81, 0xED, 0x06, 0x10,
	0x40, 0x00, 0x8B, 0x7C, 0x24, 0x04, 0x8D, 0xB5,
	0x3C, 0x34, 0x40, 0x00, 0xB9, 0xA9/* ?? */, 0x00/* ?? */, 0x00/* ?? */,
	0x00/* ?? */, 0xF3, 0xA4, 0x81, 0x7B, 0x4E, 0x54, 0x68,
	0x69, 0x73, 0x75, 0x0D, 0x8B, 0x43, 0x3C, 0x8D,
	0x04, 0x18, 0x66, 0x81, 0x38, 0x50, 0x45, 0x74,
	0x08
};


INT main(INT argc, CHAR *argv[])
{
	cXRay* XRayFile;

	printf("\n ******************************************************\n");
	printf(" * XRayMe-Test : Virus detection using XRay technique *\n");
	printf(" *    By Anwar Mohamed  <anwarelmakrahy@gmail.com>    *\n");
	printf(" ******************************************************\n\n");

	if (argc < 2)
    {
		printf(" [+] Usage : XRayMe-Test.exe virus_sample.exe\n");
		return EXIT_SUCCESS;
    }

	XRAY_VIRUS_DEFINITION VirusDef;
	memset(&VirusDef, 0, sizeof(XRAY_VIRUS_DEFINITION));

	VirusDef.StepSize = 1;
	VirusDef.Signature.Ptr = (PDWORD)VirutSign;
	VirusDef.Signature.Size = VirutSignSize;

	VirusDef.BufferAlgorithm.Type  = TYPE_XOR;

	cFile* File;
	File = new cFile(argv[1]);

	XRayFile = new cXRay(&VirusDef);
	XRayFile->CheckFile(File);

	if (!XRayFile->BufferLoaded)
	{
		printf(" [x] Buffer wasnot loaded. Exiting...\n");
		return EXIT_SUCCESS;
	}

	system("PAUSE");
	free(File);
	free(XRayFile);
	return EXIT_SUCCESS;
}